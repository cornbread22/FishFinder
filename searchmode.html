<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fishing Spots Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <style>
        html, body {
            height: 100%; /* Ensure the body takes the full height */
            margin: 0;    /* Remove default margin */
        }

        #search-container {
            padding: 10px; /* Optional padding */
            background-color: rgb(27, 191, 177); /* Header color */
            z-index: 1000; /* Ensure it's on top of the map */
            position: relative; /* Relative positioning */
        }

        #map {
            height: calc(100% - 50px); /* Full height minus the search container */
            width: 100vw; /* Full width of the viewport */
        }

        input[type="text"] {
            width: 200px; /* Set width for the input */
            padding: 5px; /* Add some padding */
            margin-right: 10px; /* Space between input and button */
        }

        button {
            padding: 5px 10px; /* Button padding */
        }
    </style>
</head>
<body>

<div id="search-container">
    <input type="text" id="location-input" placeholder="Enter location..." />
    <button id="search-button">Search</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<script>
    const map = L.map('map').setView([40, -100], 4); // Default view

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        minZoom: 2,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Function to move the map to a given location
    function moveToLocation(location) {
        fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    map.setView([lat, lon], 13); // Move the map and set zoom level
                } else {
                    alert("Location not found. Please try again.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while searching for the location.");
            });
    }

    // Event listener for the search button
    document.getElementById('search-button').addEventListener('click', () => {
        const location = document.getElementById('location-input').value;
        if (location) {
            moveToLocation(location);
        } else {
            alert("Please enter a location.");
        }
    });

    // Retrieve existing fishing spots from localStorage
    const storedSpots = JSON.parse(localStorage.getItem('fishingSpots')) || [];

    // Function to add a fishing spot to the map
    function addFishingSpot(spot) {
        const marker = L.marker([spot.lat, spot.lon], { draggable: true }).addTo(map);
        marker.bindPopup(spot.name).openPopup();

        // Event listener for dragging the marker
        marker.on('dragend', function () {
            const newLatLng = marker.getLatLng();
            spot.lat = newLatLng.lat;
            spot.lon = newLatLng.lng;

            // Update localStorage
            localStorage.setItem('fishingSpots', JSON.stringify(storedSpots));
            marker.bindPopup(spot.name).openPopup(); // Update popup position
        });

        // Event listener for clicking on the marker
        marker.on('click', function () {
             const action = prompt("Type 'r' to change the name or 'd' to delete this spot:");
            if (action === 'r') {
                const newName = prompt("Enter the new name for this fishing spot:", spot.name);
                if (newName) {
                    spot.name = newName;
                    marker.bindPopup(newName).openPopup(); // Update popup with new name
                    // Update localStorage
                    localStorage.setItem('fishingSpots', JSON.stringify(storedSpots));
                }
            } else if (action === 'd') {
                if (confirm("Are you sure you want to remove this fishing spot?")) {
                    // Remove the marker from the map
                    map.removeLayer(marker);

                    // Remove the spot from the storedSpots array
                    const index = storedSpots.findIndex(s => s.lat === spot.lat && s.lon === spot.lon);
                    if (index > -1) {
                        storedSpots.splice(index, 1); // Remove the spot
                        localStorage.setItem('fishingSpots', JSON.stringify(storedSpots)); // Update localStorage
                    }
                }
            }
        });
    }

    // Add existing fishing spots to the map
    storedSpots.forEach(addFishingSpot);

    // Enable marker placement on map click
    map.on('click', function (e) {
        const latlng = e.latlng; // Get the clicked coordinates

        // Prompt user for the fishing spot name
        const spotName = prompt("Enter the name of the fishing spot:");

        if (spotName) {
            // Create a new fishing spot object
            const newSpot = { lat: latlng.lat, lon: latlng.lng, name: spotName };

            // Add the new spot to the map
            addFishingSpot(newSpot);

            // Store the new spot in the array and save it to localStorage
            storedSpots.push(newSpot);
            localStorage.setItem('fishingSpots', JSON.stringify(storedSpots));
        }
    });
</script>

</body>
</html>
